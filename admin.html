<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="p-6 bg-gray-100">
<h1 class="text-xl font-bold mb-4">üèÄ Admin Queue Manager</h1>

<div class="mb-4">
  <input id="new-team-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡∏°‡πà" class="border p-1" required />
  <button onclick="addTeam()" class="bg-blue-600 text-white px-3 py-1 rounded">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏°</button>
</div>

<h2 class="font-semibold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</h2>
<div id="teams-table"></div>

<h2 class="font-semibold mb-2">‚öîÔ∏è ‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏ï‡∏ä‡πå</h2>
<div class="mb-6">
  <button id="run-match-btn" onclick="runMatch()" class="bg-purple-600 text-white px-4 py-2 rounded disabled:opacity-50 disabled:cursor-not-allowed">
  ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏°‡∏ï‡∏ä‡πå‡πÉ‡∏´‡∏°‡πà
  </button>
  <button onclick="clearTeams()" class="bg-red-600 text-white px-4 py-1 rounded ml-2">üóëÔ∏è ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
</div>


<h2 class="font-semibold mb-2 mt-6">üìú ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</h2>
<div id="matches-table"></div>

<h2 class="font-semibold mt-6 mb-2">üèÜ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏ô‡∏∞‡∏£‡∏ß‡∏°</h2>
<div id="win-stats-table"></div>

<script>
const editedNames = {}; 
async function post(data) {
  const res = await fetch('admin.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: new URLSearchParams(data)
  });
  const txt = await res.text();
  try {
    return JSON.parse(txt);
  } catch(e) {
    console.error('Server did not return JSON:', txt);
    alert('‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON\n‡∏î‡∏π Console ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
    throw e;
  }
}


async function deleteMatch(matchId) {
  const confirmDelete = confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ô‡∏µ‡πâ?");
  if (!confirmDelete) return;

  await post({ delete_match: 1, match_id: matchId });
  await loadAdminData();
}

async function addTeam() {
  const name = document.getElementById('new-team-name').value.trim();
  if (!name) return;
  await post({ add_team: 1, team_name: name });
  document.getElementById('new-team-name').value = '';
  await loadAdminData();
}

async function deleteTeam(id) {
  await post({ delete_team: 1, team_id: id });
  await loadAdminData();
}

async function updateTeam(id) {
  const input = document.getElementById(`new-name-${id}`);
  const newName = input.value.trim();
  if (!newName) return;
  await post({ update_team: 1, team_id: id, new_name: newName });
  await loadAdminData();
}

async function runMatch() {
  await post({ run_match: 1 });
  await loadAdminData();
}

async function recordResult(matchId) {
  const select = document.getElementById(`winner-${matchId}`);
  const winnerId = select.value;
  if (!winnerId) return;
  await post({ record_result: 1, match_id: matchId, winner_id: winnerId });
  await loadAdminData();
}

async function clearTeams() {
  const confirmClear = confirm("‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?");
  if (!confirmClear) return;
  const r = await post({ clear_teams: 1, clear_all: 1 });
  if (!r?.ok) alert('‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + (r?.error || 'unknown'));
  await loadAdminData();
}


async function loadAdminData() {
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô select (‡πÄ‡∏î‡∏¥‡∏°)
  const selectedWinners = {};
  document.querySelectorAll('select[id^="winner-"]').forEach(select => {
    selectedWinners[select.id] = select.value;
  });

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà user ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏ß‡πâ‡πÉ‡∏ô input "‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà"
  document.querySelectorAll('input[id^="new-name-"]').forEach(input => {
    editedNames[input.id] = input.value;
  });

  const res = await fetch('admin.php');
  const data = await res.json();
  const teams = data.teams;
  const matches = data.matches;

  const getName = id => {
    const t = teams.find(t => t.id == id);
    return t ? t.team_name : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠';
  };

  // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ä‡∏ô‡∏∞
  const statsRes = await fetch('admin.php?stats=1');
  const stats = await statsRes.json();

  const statRows = stats.map(s => {
    const teamName = getName(s.team_id);
    return `<tr class="text-center"><td>${teamName}</td><td>${s.total_wins}</td></tr>`;
  }).join("");

  document.getElementById("win-stats-table").innerHTML = `
    <table class="border w-full">
      <tr class="bg-gray-200 text-center">
        <th>‡∏ó‡∏µ‡∏°</th><th>‡∏ä‡∏ô‡∏∞‡∏™‡∏∞‡∏™‡∏°</th>
      </tr>${statRows}
    </table>
  `;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡∏° ‡πÇ‡∏î‡∏¢‡πÄ‡∏ï‡∏¥‡∏° value ‡∏à‡∏≤‡∏Å editedNames
  const teamRows = teams.map(t => `
    <tr class="text-center">
        <td>${t.team_name}</td>
        <td>${t.wins}</td>
        <td>${t.losses}</td>
        <td>${t.is_champion ? '‚úÖ' : ''}</td>
        <td>${t.rest_turn}</td>
        <td>${t.status}</td>
        <td class="p-2">
          <div class="flex flex-col md:flex-row items-center justify-center gap-2">
            <input 
              id="new-name-${t.id}" 
              placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà" 
              class="border p-2 rounded w-full md:w-32 text-center"
              value="${editedNames[`new-name-${t.id}`] || ''}"
              oninput="editedNames[this.id] = this.value"
            />
            <button 
              onclick="updateTeam(${t.id})" 
              class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium">
              ‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </button>
            ${
              t.status === 'Waiting' 
                ? `<button onclick="deleteTeam(${t.id})" class="bg-red-600 text-white px-3 py-1 rounded text-sm font-medium">
                    üóëÔ∏è ‡∏•‡∏ö
                  </button>` 
                : ''
            }
          </div>
        </td>
    </tr>
  `).join("");



  document.getElementById("teams-table").innerHTML = `
    <table class="border w-full mb-6">
      <tr class="bg-gray-200 text-center">
        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°</th><th>W</th><th>L</th><th>‡πÅ‡∏ä‡∏°‡∏õ‡πå</th><th>‡∏û‡∏±‡∏Å</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>${teamRows}
    </table>
  `;

  // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏°‡∏ï‡∏ä‡πå
  const matchRows = matches.map(m => {
    const winName = m.winner_id ? getName(m.winner_id) : '-';
    const loseName = m.loser_id ? getName(m.loser_id) : '-';

    const selectId = `winner-${m.match_id}`;
    const selectedValue = selectedWinners[selectId] || "";
    const deleteBtn = m.status === 'Completed'
      ? ''
      : `<button 
            onclick="deleteMatch(${m.match_id})" 
            class="bg-red-600 text-white px-3 py-1 rounded text-sm font-medium">
            üóëÔ∏è ‡∏•‡∏ö
        </button>`;


    const form = m.status === 'Pending' ? `
      <div class="flex flex-col md:flex-row items-center justify-center gap-2">
        <select id="${selectId}" class="border p-2 rounded text-sm w-full md:w-40 text-center" required>
          <option value="${m.team1_id}" ${selectedValue == m.team1_id ? "selected" : ""}>${getName(m.team1_id)}</option>
          <option value="${m.team2_id}" ${selectedValue == m.team2_id ? "selected" : ""}>${getName(m.team2_id)}</option>
        </select>
        <button 
          onclick="recordResult(${m.match_id})" 
          class="bg-blue-600 text-white px-3 py-1 rounded text-sm font-medium">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        </button>
      </div>
    ` : '‚úîÔ∏è';


    return `
    <tr class="text-center">
        <td>${getName(m.team1_id)}</td>
        <td>${getName(m.team2_id)}</td>
        <td>${winName}</td>
        <td>${loseName}</td>
        <td>${m.status}</td>
        <td>${form}</td>
        <td>${deleteBtn}</td>
    </tr>
    `;
  }).join("");

  document.getElementById("matches-table").innerHTML = `
    <table class="border w-full">
      <tr class="bg-gray-200 text-center">
        <th>‡∏ó‡∏µ‡∏° A</th><th>‡∏ó‡∏µ‡∏° B</th><th>‡∏ä‡∏ô‡∏∞</th><th>‡πÅ‡∏û‡πâ</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
      </tr>${matchRows}
    </table>
  `;
  // ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡πÅ‡∏°‡∏ï‡∏ä‡πå
  const hasPending = matches.some(m => m.status === 'Pending');
  const runMatchBtn = document.getElementById("run-match-btn");

  if (hasPending) {
    runMatchBtn.disabled = true;
    runMatchBtn.title = "‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÅ‡∏°‡∏ï‡∏ä‡πå‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•";
  } else {
    runMatchBtn.disabled = false;
    runMatchBtn.title = "";
  }
}


loadAdminData();
// ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (5000 ‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
setInterval(loadAdminData, 5000);
</script>
</body>
</html>
